#!/bin/bash
# sand — Lance un workspace SAND (Split/Across/Navigate/Destroy)
#
# Usage : sand [répertoire] [options]
#   sand                     Nouvelle session dans le répertoire courant
#   sand ~/projet            Nouvelle session dans un répertoire spécifique
#   sand diderot             Ouvrir un workspace nommé (~/.config/sand/workspaces/)
#   sand --solo              Claude Code seul
#   sand --restore / -r      Réattacher la dernière session (ou choisir via fzf)
#   sand --attach / -a       Réattacher la session du projet courant
#   sand --list / -l         Lister les sessions actives
#   sand --kill / -k         Fermer une session (sélecteur fzf)
#   sand --kill-all / -K     Fermer toutes les sessions
#   sand --keys              Aide-mémoire des raccourcis Zellij
#   sand --tips              Lancer avec un pane aide-mémoire
#   sand --open dir1 dir2    Lancer plusieurs projets dans des tabs Zellij
#
# Backends :
#   sand --tmux              Utiliser tmux au lieu de Zellij
#   sand --open --ghostty dir1 dir2   Ouvrir dans des onglets Ghostty

set -euo pipefail

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
LAYOUT_DIR="${SAND_LAYOUT_DIR:-${SCRIPT_DIR}/../layouts}"
WORKSPACES_DIR="${SAND_WORKSPACES_DIR:-${HOME}/.config/sand/workspaces}"

# --- Parsing des arguments ---
LAYOUT="default"
ACTION="create"
BACKEND="zellij"
PROJECT_DIR=""
WORKSPACE=""
OPEN_DIRS=()
TIPS=false

for arg in "$@"; do
    case "$arg" in
        --solo)           LAYOUT="solo" ;;
        --restore|-r)     ACTION="restore" ;;
        --attach|-a)      ACTION="attach" ;;
        --list|-l)        ACTION="list" ;;
        --kill|-k)        ACTION="kill" ;;
        --kill-all|-K)    ACTION="kill-all" ;;
        --open)           ACTION="open" ;;
        --keys)           ACTION="keys" ;;
        --tips)           TIPS=true ;;
        --tmux)           BACKEND="tmux" ;;
        --ghostty)        BACKEND="ghostty" ;;
        -*)               echo "Usage : sand [workspace|répertoire] [--solo|--keys|--tips|--tmux|--open [--ghostty] dir1 dir2 ...]" >&2; exit 1 ;;
        *)
            if [[ "$ACTION" == "open" ]]; then
                OPEN_DIRS+=("$arg")
            # Workspace nommé ? (pas un chemin, fichier dans workspaces/)
            elif [[ -z "$PROJECT_DIR" && ! "$arg" =~ ^[/~.] && -f "${WORKSPACES_DIR}/${arg}" ]]; then
                WORKSPACE="$arg"
            else
                PROJECT_DIR="$arg"
            fi
            ;;
    esac
done

# --- Aide-mémoire raccourcis Zellij ---
show_keys() {
    cat <<'KEYS'

  SAND — Raccourcis Zellij
  ────────────────────────

  Navigation
    Alt + ←/→/↑/↓      Changer de pane
    Alt + 1..9          Aller au tab N

  Panes  (Ctrl+P puis…)
    R  Split droite     D  Split bas
    X  Fermer           F  Plein écran
    W  Flottant

  Tabs  (Ctrl+T puis…)
    N  Nouveau          X  Fermer
    R  Renommer

  Resize  (Ctrl+N puis flèches)

  Session  (Ctrl+O puis…)
    D  Détacher         W  Session manager

KEYS
}

if [[ "$ACTION" == "keys" ]]; then
    show_keys
    exit 0
fi

# Pane tips pour les layouts dynamiques
TIPS_PANE=""
if [[ "$TIPS" == true ]]; then
    TIPS_PANE='
                pane command="bash" size="20%" {
                    args "-c" "sand --keys && sleep infinity"
                }'
fi

# --- Workspace nommé → générer le layout multi-tab ---
if [[ -n "$WORKSPACE" ]]; then
    WORKSPACE_FILE="${WORKSPACES_DIR}/${WORKSPACE}"

    TMPFILE="$(mktemp /tmp/sand-ws-XXXXXX)"
    trap 'rm -f "$TMPFILE"' EXIT

    echo "layout {" > "$TMPFILE"
    TAB_COUNT=0
    while IFS=' ' read -r name dir; do
        [[ -z "$name" || "$name" =~ ^# ]] && continue
        dir="${dir/#\~/$HOME}"
        dir="$(cd "$dir" 2>/dev/null && pwd)" || { echo "Répertoire introuvable : $dir" >&2; continue; }
        echo "  + $name ($dir)"
        cat >> "$TMPFILE" <<TABEOF
    tab name="$name" cwd="$dir" {
        pane size=1 borderless=true {
            plugin location="zellij:compact-bar"
        }
        pane split_direction="vertical" {
            pane split_direction="horizontal" size="60%" {
                pane size="70%" cwd="$dir"
                pane split_direction="vertical" size="30%" {
                    pane cwd="$dir"
                    pane cwd="$dir"
                }
            }
            pane split_direction="horizontal" size="40%" {
                pane command="lazygit" cwd="$dir"
                pane command="yazi" cwd="$dir" {
                    args "$dir"
                }${TIPS_PANE}
            }
        }
    }
TABEOF
        TAB_COUNT=$((TAB_COUNT + 1))
    done < "$WORKSPACE_FILE"
    echo "}" >> "$TMPFILE"

    [[ "$TAB_COUNT" -eq 0 ]] && { echo "Workspace $WORKSPACE vide ou invalide." >&2; exit 1; }

    # Réattacher si la session existe déjà
    if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${WORKSPACE} "; then
        echo "Workspace $WORKSPACE existant — réattachement."
        exec zellij attach "$WORKSPACE"
    fi

    echo "Lancement du workspace $WORKSPACE ($TAB_COUNT tabs)..."
    exec zellij --session "$WORKSPACE" --new-session-with-layout "$TMPFILE"
fi

PROJECT_DIR="${PROJECT_DIR:-.}"
PROJECT_DIR="$(cd "$PROJECT_DIR" 2>/dev/null && pwd)" || { echo "Répertoire introuvable : $1" >&2; exit 1; }
PROJECT_NAME="$(basename "$PROJECT_DIR")"

# --- Détection de sous-projets (répertoire parent avec plusieurs projets git) ---
if [[ "$ACTION" == "create" && "$LAYOUT" == "default" ]]; then
    SUBPROJECTS=()
    for sub in "$PROJECT_DIR"/*/; do
        [[ -d "${sub}.git" || -f "${sub}.git" ]] && SUBPROJECTS+=("$sub")
    done

    if [[ ${#SUBPROJECTS[@]} -ge 2 ]]; then
        # Sélection des sous-projets
        SELECTED=()
        if command -v fzf >/dev/null 2>&1; then
            LIST=""
            for sub in "${SUBPROJECTS[@]}"; do
                LIST+="$(basename "$sub")"$'\n'
            done
            PICKS="$(echo "$LIST" | sed '/^$/d' | fzf --multi --prompt="Tabs > " --header="Tab/Shift+Tab pour sélectionner, Entrée pour valider" --height=15 --reverse)" || exit 0
            while IFS= read -r name; do
                for sub in "${SUBPROJECTS[@]}"; do
                    [[ "$(basename "$sub")" == "$name" ]] && SELECTED+=("$sub")
                done
            done <<< "$PICKS"
        else
            echo "Répertoire $PROJECT_NAME contient ${#SUBPROJECTS[@]} projets :"
            for i in "${!SUBPROJECTS[@]}"; do
                echo "  $((i+1))) $(basename "${SUBPROJECTS[$i]}")"
            done
            echo -n "Numéros (ex: 1 2 3, ou * pour tous) > "
            read -r NUMS
            if [[ "$NUMS" == "*" ]]; then
                SELECTED=("${SUBPROJECTS[@]}")
            else
                for n in $NUMS; do
                    idx=$((n-1))
                    [[ -n "${SUBPROJECTS[$idx]:-}" ]] && SELECTED+=("${SUBPROJECTS[$idx]}")
                done
            fi
        fi

        [[ ${#SELECTED[@]} -eq 0 ]] && { echo "Aucun projet sélectionné." >&2; exit 0; }

        if [[ ${#SELECTED[@]} -eq 1 ]]; then
            # Un seul projet → session simple
            PROJECT_DIR="$(cd "${SELECTED[0]}" && pwd)"
            PROJECT_NAME="$(basename "$PROJECT_DIR")"
        else
            TMPFILE="$(mktemp /tmp/sand-auto-XXXXXX)"
            trap 'rm -f "$TMPFILE"' EXIT

            echo "layout {" > "$TMPFILE"
            for sub in "${SELECTED[@]}"; do
                sub="$(cd "$sub" && pwd)"
                name="$(basename "$sub")"
                cat >> "$TMPFILE" <<TABEOF
    tab name="$name" cwd="$sub" {
        pane size=1 borderless=true {
            plugin location="zellij:compact-bar"
        }
        pane split_direction="vertical" {
            pane size="60%" cwd="$sub"
            pane split_direction="horizontal" size="40%" {
                pane command="lazygit" cwd="$sub"
                pane command="yazi" cwd="$sub" {
                    args "$sub"
                }
            }
        }
    }
TABEOF
            done
            echo "}" >> "$TMPFILE"

            # Réattacher si la session existe
            if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${PROJECT_NAME} "; then
                echo "Session $PROJECT_NAME existante — réattachement."
                exec zellij attach "$PROJECT_NAME"
            fi

            echo "Lancement de ${#SELECTED[@]} tabs..."
            exec zellij --session "$PROJECT_NAME" --new-session-with-layout "$TMPFILE"
        fi
    fi
fi

# --- Détection de nesting ---
if [[ "$ACTION" == "create" ]]; then
    if [[ -n "${ZELLIJ:-}" && "$BACKEND" == "zellij" ]]; then
        echo "Déjà dans Zellij. Utilise Ctrl+O puis W pour switcher de session." >&2
        exit 1
    fi
    if [[ -n "${TMUX:-}" && "$BACKEND" == "tmux" ]]; then
        echo "Déjà dans tmux. Utilise prefix+s pour switcher de session." >&2
        exit 1
    fi
fi

# --- Vérification des dépendances ---
missing=()
if [[ "$BACKEND" == "zellij" ]]; then
    command -v zellij >/dev/null 2>&1 || missing+=("zellij")
elif [[ "$BACKEND" == "tmux" ]]; then
    command -v tmux >/dev/null 2>&1 || missing+=("tmux")
fi
if [[ "$LAYOUT" != "solo" ]]; then
    command -v lazygit >/dev/null 2>&1 || missing+=("lazygit")
    command -v yazi    >/dev/null 2>&1 || missing+=("yazi")
fi

if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Dépendances manquantes : ${missing[*]}" >&2
    echo "Installe-les avec : brew install ${missing[*]}" >&2
    exit 1
fi

# =============================================
# Actions rapides (indépendantes du backend)
# =============================================

if [[ "$ACTION" == "list" ]]; then
    echo "Sessions SAND actives :"
    if [[ "$BACKEND" == "tmux" ]]; then
        tmux list-sessions 2>/dev/null || echo "  (aucune)"
    else
        zellij list-sessions 2>/dev/null || echo "  (aucune)"
    fi
    exit 0
fi

if [[ "$ACTION" == "restore" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        SESSIONS="$(tmux list-sessions -F '#S' 2>/dev/null)" || { echo "Aucune session active." >&2; exit 1; }
    else
        SESSIONS="$(zellij list-sessions --no-formatting 2>/dev/null | awk '{print $1}')" || true
    fi

    [[ -z "$SESSIONS" ]] && { echo "Aucune session active." >&2; exit 1; }

    # Une seule session → réattacher directement
    COUNT="$(echo "$SESSIONS" | wc -l | tr -d ' ')"
    if [[ "$COUNT" -eq 1 ]]; then
        SESSION="$SESSIONS"
    elif command -v fzf >/dev/null 2>&1; then
        SESSION="$(echo "$SESSIONS" | fzf --prompt="Session > " --height=10 --reverse)" || exit 0
    else
        echo "Sessions disponibles :"
        echo "$SESSIONS" | nl
        echo -n "Numéro > "
        read -r NUM
        SESSION="$(echo "$SESSIONS" | sed -n "${NUM}p")"
        [[ -z "$SESSION" ]] && { echo "Choix invalide." >&2; exit 1; }
    fi

    echo "Réattachement à $SESSION..."
    if [[ "$BACKEND" == "tmux" ]]; then
        exec tmux attach-session -t "$SESSION"
    else
        exec zellij attach "$SESSION"
    fi
fi

if [[ "$ACTION" == "kill" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        SESSIONS="$(tmux list-sessions -F '#S' 2>/dev/null)" || { echo "Aucune session active." >&2; exit 1; }
    else
        SESSIONS="$(zellij list-sessions --no-formatting 2>/dev/null | awk '{print $1}')" || true
    fi

    [[ -z "$SESSIONS" ]] && { echo "Aucune session active." >&2; exit 1; }

    # Si un répertoire est passé explicitement, tuer cette session
    if [[ "$PROJECT_DIR" != "$(pwd)" ]] || [[ $# -gt 0 && "$1" != "--kill" && "$1" != "-k" ]]; then
        SESSION="$PROJECT_NAME"
    elif command -v fzf >/dev/null 2>&1; then
        SESSION="$(echo "$SESSIONS" | fzf --prompt="Fermer > " --height=10 --reverse)" || exit 0
    else
        echo "Sessions disponibles :"
        echo "$SESSIONS" | nl
        echo -n "Numéro > "
        read -r NUM
        SESSION="$(echo "$SESSIONS" | sed -n "${NUM}p")"
        [[ -z "$SESSION" ]] && { echo "Choix invalide." >&2; exit 1; }
    fi

    if [[ "$BACKEND" == "tmux" ]]; then
        tmux kill-session -t "$SESSION" 2>/dev/null && echo "Session $SESSION fermée." || echo "Pas de session $SESSION." >&2
    else
        zellij delete-session "$SESSION" --force 2>/dev/null && echo "Session $SESSION fermée." || echo "Pas de session $SESSION." >&2
    fi
    exit 0
fi

if [[ "$ACTION" == "kill-all" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        tmux kill-server 2>/dev/null && echo "Toutes les sessions tmux fermées." || echo "Aucune session active." >&2
    else
        zellij delete-all-sessions --force --yes 2>/dev/null && echo "Toutes les sessions Zellij fermées." || echo "Aucune session active." >&2
    fi
    exit 0
fi

if [[ "$ACTION" == "attach" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        cd "$PROJECT_DIR"
        exec tmux attach-session -t "$PROJECT_NAME"
    else
        if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${PROJECT_NAME} "; then
            cd "$PROJECT_DIR"
            exec zellij attach "$PROJECT_NAME"
        else
            echo "Pas de session $PROJECT_NAME. Sessions disponibles :" >&2
            zellij list-sessions 2>/dev/null || echo "  (aucune)"
            exit 1
        fi
    fi
fi

# =============================================
# --open : plusieurs projets
# =============================================

if [[ "$ACTION" == "open" ]]; then
    [[ ${#OPEN_DIRS[@]} -eq 0 ]] && { echo "Usage : sand --open dir1 dir2 ..." >&2; exit 1; }

    # --- Mode Ghostty : un onglet Ghostty par projet ---
    if [[ "$BACKEND" == "ghostty" ]]; then
        echo "Ouverture de ${#OPEN_DIRS[@]} onglet(s) Ghostty..."
        SCRIPT='tell application "Ghostty" to activate
delay 0.3
tell application "System Events"
  tell process "Ghostty"'
        for dir in "${OPEN_DIRS[@]}"; do
            dir="$(cd "$dir" 2>/dev/null && pwd)" || { echo "Répertoire introuvable : $dir" >&2; continue; }
            name="$(basename "$dir")"
            echo "  + $name"
            SCRIPT="$SCRIPT
    keystroke \"t\" using command down
    delay 1
    keystroke \"sand ${dir}\"
    delay 0.3
    keystroke return
    delay 1.5"
        done
        SCRIPT="$SCRIPT
  end tell
end tell"
        osascript -e "$SCRIPT" 2>&1 || echo "Erreur osascript — vérifie les permissions Accessibilité."
        exit 0
    fi

    # --- Mode Zellij (défaut) : un tab Zellij par projet ---
    TMPFILE="$(mktemp /tmp/sand-multi-XXXXXX)"
    trap 'rm -f "$TMPFILE"' EXIT

    echo "layout {" > "$TMPFILE"
    for dir in "${OPEN_DIRS[@]}"; do
        dir="$(cd "$dir" 2>/dev/null && pwd)" || { echo "Répertoire introuvable : $dir" >&2; continue; }
        name="$(basename "$dir")"
        echo "  + $name"
        cat >> "$TMPFILE" <<TABEOF
    tab name="$name" cwd="$dir" {
        pane size=1 borderless=true {
            plugin location="zellij:compact-bar"
        }
        pane split_direction="vertical" {
            pane split_direction="horizontal" size="60%" {
                pane size="70%" cwd="$dir"
                pane split_direction="vertical" size="30%" {
                    pane cwd="$dir"
                    pane cwd="$dir"
                }
            }
            pane split_direction="horizontal" size="40%" {
                pane command="lazygit" cwd="$dir"
                pane command="yazi" cwd="$dir" {
                    args "$dir"
                }${TIPS_PANE}
            }
        }
    }
TABEOF
    done
    echo "}" >> "$TMPFILE"

    SESSION_NAME="sand-$(date +%H%M%S)"
    echo "Lancement de ${#OPEN_DIRS[@]} tab(s) Zellij dans la session $SESSION_NAME..."
    exec zellij --session "$SESSION_NAME" --new-session-with-layout "$TMPFILE"
fi

# =============================================
# Lancement de session unique
# =============================================

# --- Backend tmux ---
if [[ "$BACKEND" == "tmux" ]]; then
    # Réattacher si la session existe
    if tmux has-session -t "$PROJECT_NAME" 2>/dev/null; then
        echo "Session tmux $PROJECT_NAME existante — réattachement."
        cd "$PROJECT_DIR"
        exec tmux attach-session -t "$PROJECT_NAME"
    fi

    cd "$PROJECT_DIR"

    if [[ "$LAYOUT" == "solo" ]]; then
        exec tmux new-session -s "$PROJECT_NAME"
    fi

    # Layout : Claude (gauche 60%) | lazygit + yazi (droite 40%)
    tmux new-session -d -s "$PROJECT_NAME" -x "$(tput cols)" -y "$(tput lines)"
    tmux split-window -h -t "$PROJECT_NAME" -p 40
    tmux split-window -v -t "$PROJECT_NAME:0.1"
    tmux send-keys -t "$PROJECT_NAME:0.1" "lazygit" Enter
    tmux send-keys -t "$PROJECT_NAME:0.2" "yazi" Enter
    tmux select-pane -t "$PROJECT_NAME:0.0"
    exec tmux attach-session -t "$PROJECT_NAME"
fi

# --- Backend Zellij (défaut) ---

# Réattacher si la session existe
if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${PROJECT_NAME} "; then
    echo "Session $PROJECT_NAME existante — réattachement."
    cd "$PROJECT_DIR"
    exec zellij attach "$PROJECT_NAME"
fi

# Choisir le layout
if [[ "$LAYOUT" == "solo" ]]; then
    LAYOUT_FILE="${LAYOUT_DIR}/sand-solo.kdl"
elif [[ "$TIPS" == true ]]; then
    LAYOUT_FILE="$(mktemp /tmp/sand-tips-XXXXXX)"
    trap 'rm -f "$LAYOUT_FILE"' EXIT
    cat > "$LAYOUT_FILE" <<TIPSEOF
layout {
    pane size=1 borderless=true {
        plugin location="zellij:compact-bar"
    }
    pane split_direction="vertical" {
        pane split_direction="horizontal" size="60%" {
            pane size="70%"
            pane split_direction="vertical" size="30%" {
                pane
                pane
            }
        }
        pane split_direction="horizontal" size="40%" {
            pane command="lazygit"
            pane command="yazi" {
                args "."
            }
            pane command="bash" size="20%" {
                args "-c" "sand --keys && sleep infinity"
            }
        }
    }
}
TIPSEOF
else
    LAYOUT_FILE="${LAYOUT_DIR}/sand.kdl"
fi

if [[ ! -f "$LAYOUT_FILE" ]]; then
    echo "Layout introuvable : $LAYOUT_FILE" >&2
    exit 1
fi

cd "$PROJECT_DIR"
exec zellij --session "$PROJECT_NAME" --new-session-with-layout "$LAYOUT_FILE"
