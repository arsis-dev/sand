#!/bin/bash
# sand — Launch a SAND workspace (Split/Across/Navigate/Destroy)
#
# Usage: sand [directory] [options]
#   sand                     New session in the current directory
#   sand ~/project           New session in a specific directory
#   sand diderot             Open a named workspace (~/.config/sand/workspaces/)
#   sand --solo              Claude Code only
#   sand --restore / -r      Reattach the last session (or choose via fzf)
#   sand --attach / -a       Reattach the current project's session
#   sand --list / -l         List active sessions
#   sand --kill / -k         Close a session (fzf selector)
#   sand --kill-all / -K     Close all sessions
#   sand --keys              Zellij shortcuts cheat sheet
#   sand --tips              Launch with a cheat sheet pane
#   sand --open dir1 dir2    Launch multiple projects in Zellij tabs
#
# Backends:
#   sand --tmux              Use tmux instead of Zellij
#   sand --open --ghostty dir1 dir2   Open in Ghostty tabs

set -euo pipefail

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
LAYOUT_DIR="${SAND_LAYOUT_DIR:-${SCRIPT_DIR}/../layouts}"
WORKSPACES_DIR="${SAND_WORKSPACES_DIR:-${HOME}/.config/sand/workspaces}"

# --- Argument parsing ---
LAYOUT="default"
ACTION="create"
BACKEND="zellij"
PROJECT_DIR=""
WORKSPACE=""
OPEN_DIRS=()
TIPS=false
WS_SUBCOMMAND=""
WS_ARGS=()
HELPER="${SCRIPT_DIR}/sand-workspace-helper"

for arg in "$@"; do
    case "$arg" in
        --solo)           LAYOUT="solo" ;;
        --restore|-r)     ACTION="restore" ;;
        --attach|-a)      ACTION="attach" ;;
        --list|-l)        ACTION="list" ;;
        --kill|-k)        ACTION="kill" ;;
        --kill-all|-K)    ACTION="kill-all" ;;
        --open)           ACTION="open" ;;
        --keys)           ACTION="keys" ;;
        --tips)           TIPS=true ;;
        --tmux)           BACKEND="tmux" ;;
        --ghostty)        BACKEND="ghostty" ;;
        workspace)
            if [[ "$ACTION" == "open" ]]; then
                OPEN_DIRS+=("$arg")
            else
                ACTION="workspace"
            fi
            ;;
        -*)               echo "Usage: sand [workspace|directory] [--solo|--keys|--tips|--tmux|--open [--ghostty] dir1 dir2 ...]" >&2; exit 1 ;;
        *)
            if [[ "$ACTION" == "workspace" ]]; then
                if [[ -z "$WS_SUBCOMMAND" ]]; then
                    WS_SUBCOMMAND="$arg"
                else
                    WS_ARGS+=("$arg")
                fi
            elif [[ "$ACTION" == "open" ]]; then
                OPEN_DIRS+=("$arg")
            # Named workspace? (not a path, TOML or old format file in workspaces/)
            elif [[ -z "$PROJECT_DIR" && ! "$arg" =~ ^[/~.] && ( -f "${WORKSPACES_DIR}/${arg}.toml" || -f "${WORKSPACES_DIR}/${arg}" ) ]]; then
                WORKSPACE="$arg"
            else
                PROJECT_DIR="$arg"
            fi
            ;;
    esac
done

# --- Zellij shortcuts cheat sheet ---
show_keys() {
    cat <<'KEYS'

  SAND — Zellij Shortcuts
  ────────────────────────

  Navigation
    Alt + ←/→/↑/↓      Switch pane
    Alt + 1..9          Go to tab N

  Panes  (Ctrl+P then…)
    R  Split right      D  Split down
    X  Close            F  Fullscreen
    W  Floating

  Tabs  (Ctrl+T then…)
    N  New              X  Close
    R  Rename

  Resize  (Ctrl+N then arrows)

  Session  (Ctrl+O then…)
    D  Detach           W  Session manager

KEYS
}

if [[ "$ACTION" == "keys" ]]; then
    show_keys
    exit 0
fi

# =============================================
# Workspace subcommand
# =============================================

if [[ "$ACTION" == "workspace" ]]; then
    case "${WS_SUBCOMMAND:-}" in
        new)
            python3 "$HELPER" wizard
            ;;
        list|ls)
            echo "Sand workspaces:"
            for f in "$WORKSPACES_DIR"/*; do
                [[ -f "$f" ]] || continue
                [[ "$f" == *.bak ]] && continue
                name=$(basename "$f" .toml)
                if [[ "$f" == *.toml ]]; then
                    desc=$(python3 -c "
import tomllib, sys
with open('$f', 'rb') as fh:
    c = tomllib.load(fh)
ws = c.get('workspace', {})
tabs = c.get('tabs', [])
desc = ws.get('description', '')
names = ', '.join(t.get('name', '?') for t in tabs)
print(f'{len(tabs)} tab(s): {names}')
if desc: print(f'  {desc}')
" 2>/dev/null)
                    echo "  ● $name  $desc"
                else
                    lines=$(grep -cv '^#\|^$' "$f" 2>/dev/null || echo 0)
                    echo "  ○ $name  (old format, $lines tab(s) — sand workspace migrate)"
                fi
            done
            ;;
        show)
            ws_name="${WS_ARGS[0]:?Usage: sand workspace show <name>}"
            ws_file="$WORKSPACES_DIR/${ws_name}.toml"
            if [[ ! -f "$ws_file" ]]; then
                echo "Unknown workspace: $ws_name" >&2
                exit 1
            fi
            echo "── Workspace: $ws_name ──"
            python3 "$HELPER" validate "$ws_file"
            echo ""
            cat "$ws_file"
            ;;
        edit)
            ws_name="${WS_ARGS[0]:?Usage: sand workspace edit <name>}"
            ws_file="$WORKSPACES_DIR/${ws_name}.toml"
            if [[ ! -f "$ws_file" ]]; then
                echo "Unknown workspace: $ws_name" >&2
                exit 1
            fi
            "${EDITOR:-vi}" "$ws_file"
            python3 "$HELPER" validate "$ws_file"
            ;;
        delete|rm)
            ws_name="${WS_ARGS[0]:?Usage: sand workspace delete <name>}"
            ws_file="$WORKSPACES_DIR/${ws_name}.toml"
            if [[ ! -f "$ws_file" ]]; then
                echo "Unknown workspace: $ws_name" >&2
                exit 1
            fi
            echo -n "Delete workspace '$ws_name'? [y/N] "
            read -r confirm
            if [[ "$confirm" =~ ^[oOyY] ]]; then
                rm "$ws_file"
                echo "Workspace '$ws_name' deleted."
            else
                echo "Cancelled."
            fi
            ;;
        migrate)
            migrated=0
            for f in "$WORKSPACES_DIR"/*; do
                [[ -f "$f" ]] || continue
                [[ "$f" == *.toml || "$f" == *.bak ]] && continue
                name=$(basename "$f")
                toml_file="$WORKSPACES_DIR/${name}.toml"
                if [[ -f "$toml_file" ]]; then
                    echo "  ⏭ $name — .toml already exists"
                    continue
                fi
                python3 "$HELPER" migrate "$f" > "$toml_file"
                mv "$f" "${f}.bak"
                echo "  ✓ $name → ${name}.toml (old file backed up as .bak)"
                migrated=$((migrated + 1))
            done
            if [[ "$migrated" -eq 0 ]]; then
                echo "Nothing to migrate."
            else
                echo "$migrated workspace(s) migrated."
            fi
            ;;
        catalog)
            python3 "$HELPER" catalog
            ;;
        "")
            echo "sand workspace — workspace management"
            echo ""
            echo "  new                 Create a workspace (interactive wizard)"
            echo "  list                List workspaces"
            echo "  show <name>         Show a workspace"
            echo "  edit <name>         Edit a workspace in \$EDITOR"
            echo "  delete <name>       Delete a workspace"
            echo "  migrate             Migrate old plain text files to TOML"
            echo "  catalog             Available TUI apps catalog"
            ;;
        *)
            echo "Unknown subcommand: $WS_SUBCOMMAND" >&2
            echo "Usage: sand workspace [new|list|show|edit|delete|migrate|catalog]" >&2
            exit 1
            ;;
    esac
    exit 0
fi

# Tips pane for dynamic layouts
TIPS_PANE=""
if [[ "$TIPS" == true ]]; then
    TIPS_PANE='
                pane command="bash" size="20%" {
                    args "-c" "sand --keys && sleep infinity"
                }'
fi

# --- Named workspace → generate layout from TOML ---
if [[ -n "$WORKSPACE" ]]; then
    TOML_FILE="${WORKSPACES_DIR}/${WORKSPACE}.toml"
    OLD_FILE="${WORKSPACES_DIR}/${WORKSPACE}"

    # Auto-migrate if old format detected
    if [[ ! -f "$TOML_FILE" && -f "$OLD_FILE" ]]; then
        echo "Migrating workspace $WORKSPACE to TOML..."
        python3 "$HELPER" migrate "$OLD_FILE" > "$TOML_FILE"
        mv "$OLD_FILE" "${OLD_FILE}.bak"
        echo "  ✓ Migrated to ${WORKSPACE}.toml (old file backed up as .bak)"
    fi

    if [[ ! -f "$TOML_FILE" ]]; then
        echo "Workspace not found: $WORKSPACE" >&2
        echo "Available workspaces:"
        ls -1 "$WORKSPACES_DIR"/*.toml 2>/dev/null | xargs -I{} basename {} .toml | sed 's/^/  /'
        exit 1
    fi

    if [[ "$BACKEND" == "tmux" ]]; then
        # --- tmux backend ---
        if tmux has-session -t "$WORKSPACE" 2>/dev/null; then
            echo "Existing tmux session $WORKSPACE — reattaching."
            exec tmux attach-session -t "$WORKSPACE"
        fi

        TMPFILE="$(mktemp /tmp/sand-ws-XXXXXX)"
        trap 'rm -f "$TMPFILE"' EXIT

        if ! python3 "$HELPER" render-tmux "$TOML_FILE" --session "$WORKSPACE" > "$TMPFILE"; then
            echo "Error generating tmux layout for $WORKSPACE" >&2
            exit 1
        fi

        echo "Launching workspace $WORKSPACE (tmux)..."
        exec bash "$TMPFILE"
    else
        # --- Zellij backend (default) ---
        if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${WORKSPACE} "; then
            echo "Existing workspace $WORKSPACE — reattaching."
            exec zellij attach "$WORKSPACE"
        fi

        TMPFILE="$(mktemp /tmp/sand-ws-XXXXXX)"
        trap 'rm -f "$TMPFILE"' EXIT

        if ! python3 "$HELPER" render "$TOML_FILE" > "$TMPFILE"; then
            echo "Error generating layout for $WORKSPACE" >&2
            exit 1
        fi

        echo "Launching workspace $WORKSPACE..."
        exec zellij --session "$WORKSPACE" --new-session-with-layout "$TMPFILE"
    fi
fi

PROJECT_DIR="${PROJECT_DIR:-.}"
PROJECT_DIR="$(cd "$PROJECT_DIR" 2>/dev/null && pwd)" || { echo "Directory not found: $1" >&2; exit 1; }
PROJECT_NAME="$(basename "$PROJECT_DIR")"

# --- Sub-project detection (parent directory with multiple git projects) ---
if [[ "$ACTION" == "create" && "$LAYOUT" == "default" ]]; then
    SUBPROJECTS=()
    for sub in "$PROJECT_DIR"/*/; do
        [[ -d "${sub}.git" || -f "${sub}.git" ]] && SUBPROJECTS+=("$sub")
    done

    if [[ ${#SUBPROJECTS[@]} -ge 2 ]]; then
        # Sub-project selection
        SELECTED=()
        if command -v fzf >/dev/null 2>&1; then
            LIST=""
            for sub in "${SUBPROJECTS[@]}"; do
                LIST+="$(basename "$sub")"$'\n'
            done
            PICKS="$(echo "$LIST" | sed '/^$/d' | fzf --multi --prompt="Tabs > " --header="Tab/Shift+Tab to select, Enter to confirm" --height=15 --reverse)" || exit 0
            while IFS= read -r name; do
                for sub in "${SUBPROJECTS[@]}"; do
                    [[ "$(basename "$sub")" == "$name" ]] && SELECTED+=("$sub")
                done
            done <<< "$PICKS"
        else
            echo "Directory $PROJECT_NAME contains ${#SUBPROJECTS[@]} projects:"
            for i in "${!SUBPROJECTS[@]}"; do
                echo "  $((i+1))) $(basename "${SUBPROJECTS[$i]}")"
            done
            echo -n "Numbers (e.g. 1 2 3, or * for all) > "
            read -r NUMS
            if [[ "$NUMS" == "*" ]]; then
                SELECTED=("${SUBPROJECTS[@]}")
            else
                for n in $NUMS; do
                    idx=$((n-1))
                    [[ -n "${SUBPROJECTS[$idx]:-}" ]] && SELECTED+=("${SUBPROJECTS[$idx]}")
                done
            fi
        fi

        [[ ${#SELECTED[@]} -eq 0 ]] && { echo "No project selected." >&2; exit 0; }

        if [[ ${#SELECTED[@]} -eq 1 ]]; then
            # Single project → simple session
            PROJECT_DIR="$(cd "${SELECTED[0]}" && pwd)"
            PROJECT_NAME="$(basename "$PROJECT_DIR")"
        else
            TMPFILE="$(mktemp /tmp/sand-auto-XXXXXX)"
            trap 'rm -f "$TMPFILE"' EXIT

            echo "layout {" > "$TMPFILE"
            for sub in "${SELECTED[@]}"; do
                sub="$(cd "$sub" && pwd)"
                name="$(basename "$sub")"
                cat >> "$TMPFILE" <<TABEOF
    tab name="$name" cwd="$sub" {
        pane size=1 borderless=true {
            plugin location="zellij:compact-bar"
        }
        pane split_direction="vertical" {
            pane size="60%" cwd="$sub"
            pane split_direction="horizontal" size="40%" {
                pane command="lazygit" cwd="$sub"
                pane command="yazi" cwd="$sub" {
                    args "$sub"
                }
            }
        }
    }
TABEOF
            done
            echo "}" >> "$TMPFILE"

            # Reattach if session exists
            if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${PROJECT_NAME} "; then
                echo "Existing session $PROJECT_NAME — reattaching."
                exec zellij attach "$PROJECT_NAME"
            fi

            echo "Launching ${#SELECTED[@]} tabs..."
            exec zellij --session "$PROJECT_NAME" --new-session-with-layout "$TMPFILE"
        fi
    fi
fi

# --- Nesting detection ---
if [[ "$ACTION" == "create" ]]; then
    if [[ -n "${ZELLIJ:-}" && "$BACKEND" == "zellij" ]]; then
        echo "Already inside Zellij. Use Ctrl+O then W to switch sessions." >&2
        exit 1
    fi
    if [[ -n "${TMUX:-}" && "$BACKEND" == "tmux" ]]; then
        echo "Already inside tmux. Use prefix+s to switch sessions." >&2
        exit 1
    fi
fi

# --- Dependency check ---
missing=()
if [[ "$BACKEND" == "zellij" ]]; then
    command -v zellij >/dev/null 2>&1 || missing+=("zellij")
elif [[ "$BACKEND" == "tmux" ]]; then
    command -v tmux >/dev/null 2>&1 || missing+=("tmux")
fi
if [[ "$LAYOUT" != "solo" ]]; then
    command -v lazygit >/dev/null 2>&1 || missing+=("lazygit")
    command -v yazi    >/dev/null 2>&1 || missing+=("yazi")
fi

if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Missing dependencies: ${missing[*]}" >&2
    echo "Install with: brew install ${missing[*]}" >&2
    exit 1
fi

# =============================================
# Quick actions (backend-independent)
# =============================================

if [[ "$ACTION" == "list" ]]; then
    echo "Active SAND sessions:"
    if [[ "$BACKEND" == "tmux" ]]; then
        tmux list-sessions 2>/dev/null || echo "  (none)"
    else
        zellij list-sessions 2>/dev/null || echo "  (none)"
    fi
    exit 0
fi

if [[ "$ACTION" == "restore" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        SESSIONS="$(tmux list-sessions -F '#S' 2>/dev/null)" || { echo "No active sessions." >&2; exit 1; }
    else
        SESSIONS="$(zellij list-sessions --no-formatting 2>/dev/null | awk '{print $1}')" || true
    fi

    [[ -z "$SESSIONS" ]] && { echo "No active sessions." >&2; exit 1; }

    # Single session → reattach directly
    COUNT="$(echo "$SESSIONS" | wc -l | tr -d ' ')"
    if [[ "$COUNT" -eq 1 ]]; then
        SESSION="$SESSIONS"
    elif command -v fzf >/dev/null 2>&1; then
        SESSION="$(echo "$SESSIONS" | fzf --prompt="Session > " --height=10 --reverse)" || exit 0
    else
        echo "Available sessions:"
        echo "$SESSIONS" | nl
        echo -n "Number > "
        read -r NUM
        SESSION="$(echo "$SESSIONS" | sed -n "${NUM}p")"
        [[ -z "$SESSION" ]] && { echo "Invalid choice." >&2; exit 1; }
    fi

    echo "Reattaching to $SESSION..."
    if [[ "$BACKEND" == "tmux" ]]; then
        exec tmux attach-session -t "$SESSION"
    else
        exec zellij attach "$SESSION"
    fi
fi

if [[ "$ACTION" == "kill" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        SESSIONS="$(tmux list-sessions -F '#S' 2>/dev/null)" || { echo "No active sessions." >&2; exit 1; }
    else
        SESSIONS="$(zellij list-sessions --no-formatting 2>/dev/null | awk '{print $1}')" || true
    fi

    [[ -z "$SESSIONS" ]] && { echo "No active sessions." >&2; exit 1; }

    # If a directory was explicitly passed, kill that session
    if [[ "$PROJECT_DIR" != "$(pwd)" ]] || [[ $# -gt 0 && "$1" != "--kill" && "$1" != "-k" ]]; then
        SESSION="$PROJECT_NAME"
    elif command -v fzf >/dev/null 2>&1; then
        SESSION="$(echo "$SESSIONS" | fzf --prompt="Close > " --height=10 --reverse)" || exit 0
    else
        echo "Available sessions:"
        echo "$SESSIONS" | nl
        echo -n "Number > "
        read -r NUM
        SESSION="$(echo "$SESSIONS" | sed -n "${NUM}p")"
        [[ -z "$SESSION" ]] && { echo "Invalid choice." >&2; exit 1; }
    fi

    if [[ "$BACKEND" == "tmux" ]]; then
        tmux kill-session -t "$SESSION" 2>/dev/null && echo "Session $SESSION closed." || echo "No session $SESSION." >&2
    else
        zellij delete-session "$SESSION" --force 2>/dev/null && echo "Session $SESSION closed." || echo "No session $SESSION." >&2
    fi
    exit 0
fi

if [[ "$ACTION" == "kill-all" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        tmux kill-server 2>/dev/null && echo "All tmux sessions closed." || echo "No active sessions." >&2
    else
        zellij delete-all-sessions --force --yes 2>/dev/null && echo "All Zellij sessions closed." || echo "No active sessions." >&2
    fi
    exit 0
fi

if [[ "$ACTION" == "attach" ]]; then
    if [[ "$BACKEND" == "tmux" ]]; then
        cd "$PROJECT_DIR"
        exec tmux attach-session -t "$PROJECT_NAME"
    else
        if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${PROJECT_NAME} "; then
            cd "$PROJECT_DIR"
            exec zellij attach "$PROJECT_NAME"
        else
            echo "No session $PROJECT_NAME. Available sessions:" >&2
            zellij list-sessions 2>/dev/null || echo "  (none)"
            exit 1
        fi
    fi
fi

# =============================================
# --open: multiple projects
# =============================================

if [[ "$ACTION" == "open" ]]; then
    [[ ${#OPEN_DIRS[@]} -eq 0 ]] && { echo "Usage: sand --open dir1 dir2 ..." >&2; exit 1; }

    # --- Ghostty mode: one Ghostty tab per project ---
    if [[ "$BACKEND" == "ghostty" ]]; then
        echo "Opening ${#OPEN_DIRS[@]} Ghostty tab(s)..."
        SCRIPT='tell application "Ghostty" to activate
delay 0.3
tell application "System Events"
  tell process "Ghostty"'
        for dir in "${OPEN_DIRS[@]}"; do
            dir="$(cd "$dir" 2>/dev/null && pwd)" || { echo "Directory not found: $dir" >&2; continue; }
            name="$(basename "$dir")"
            echo "  + $name"
            SCRIPT="$SCRIPT
    keystroke \"t\" using command down
    delay 1
    keystroke \"sand ${dir}\"
    delay 0.3
    keystroke return
    delay 1.5"
        done
        SCRIPT="$SCRIPT
  end tell
end tell"
        osascript -e "$SCRIPT" 2>&1 || echo "osascript error — check Accessibility permissions."
        exit 0
    fi

    # --- Zellij mode (default): one Zellij tab per project ---
    TMPFILE="$(mktemp /tmp/sand-multi-XXXXXX)"
    trap 'rm -f "$TMPFILE"' EXIT

    echo "layout {" > "$TMPFILE"
    for dir in "${OPEN_DIRS[@]}"; do
        dir="$(cd "$dir" 2>/dev/null && pwd)" || { echo "Directory not found: $dir" >&2; continue; }
        name="$(basename "$dir")"
        echo "  + $name"
        cat >> "$TMPFILE" <<TABEOF
    tab name="$name" cwd="$dir" {
        pane size=1 borderless=true {
            plugin location="zellij:compact-bar"
        }
        pane split_direction="vertical" {
            pane split_direction="horizontal" size="60%" {
                pane size="70%" cwd="$dir"
                pane split_direction="vertical" size="30%" {
                    pane cwd="$dir"
                    pane cwd="$dir"
                }
            }
            pane split_direction="horizontal" size="40%" {
                pane command="lazygit" cwd="$dir"
                pane command="yazi" cwd="$dir" {
                    args "$dir"
                }${TIPS_PANE}
            }
        }
    }
TABEOF
    done
    echo "}" >> "$TMPFILE"

    SESSION_NAME="sand-$(date +%H%M%S)"
    echo "Launching ${#OPEN_DIRS[@]} Zellij tab(s) in session $SESSION_NAME..."
    exec zellij --session "$SESSION_NAME" --new-session-with-layout "$TMPFILE"
fi

# =============================================
# Single session launch
# =============================================

# --- tmux backend ---
if [[ "$BACKEND" == "tmux" ]]; then
    # Reattach if session exists
    if tmux has-session -t "$PROJECT_NAME" 2>/dev/null; then
        echo "Existing tmux session $PROJECT_NAME — reattaching."
        cd "$PROJECT_DIR"
        exec tmux attach-session -t "$PROJECT_NAME"
    fi

    cd "$PROJECT_DIR"

    if [[ "$LAYOUT" == "solo" ]]; then
        exec tmux new-session -s "$PROJECT_NAME"
    fi

    # Layout: Claude (left 60%) | lazygit + yazi (right 40%)
    tmux new-session -d -s "$PROJECT_NAME" -x "$(tput cols)" -y "$(tput lines)"
    tmux split-window -h -t "$PROJECT_NAME" -p 40
    tmux split-window -v -t "$PROJECT_NAME:0.1"
    tmux send-keys -t "$PROJECT_NAME:0.1" "lazygit" Enter
    tmux send-keys -t "$PROJECT_NAME:0.2" "yazi" Enter
    tmux select-pane -t "$PROJECT_NAME:0.0"
    exec tmux attach-session -t "$PROJECT_NAME"
fi

# --- Zellij backend (default) ---

# Reattach if session exists
if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${PROJECT_NAME} "; then
    echo "Existing session $PROJECT_NAME — reattaching."
    cd "$PROJECT_DIR"
    exec zellij attach "$PROJECT_NAME"
fi

# Choose layout
if [[ "$LAYOUT" == "solo" ]]; then
    LAYOUT_FILE="${LAYOUT_DIR}/sand-solo.kdl"
elif [[ "$TIPS" == true ]]; then
    LAYOUT_FILE="$(mktemp /tmp/sand-tips-XXXXXX)"
    trap 'rm -f "$LAYOUT_FILE"' EXIT
    cat > "$LAYOUT_FILE" <<TIPSEOF
layout {
    pane size=1 borderless=true {
        plugin location="zellij:compact-bar"
    }
    pane split_direction="vertical" {
        pane split_direction="horizontal" size="60%" {
            pane size="70%"
            pane split_direction="vertical" size="30%" {
                pane
                pane
            }
        }
        pane split_direction="horizontal" size="40%" {
            pane command="lazygit"
            pane command="yazi" {
                args "."
            }
            pane command="bash" size="20%" {
                args "-c" "sand --keys && sleep infinity"
            }
        }
    }
}
TIPSEOF
else
    LAYOUT_FILE="${LAYOUT_DIR}/sand.kdl"
fi

if [[ ! -f "$LAYOUT_FILE" ]]; then
    echo "Layout not found: $LAYOUT_FILE" >&2
    exit 1
fi

cd "$PROJECT_DIR"
exec zellij --session "$PROJECT_NAME" --new-session-with-layout "$LAYOUT_FILE"
